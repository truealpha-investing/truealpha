<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaderboard | True Alpha</title>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ✅ DO NOT name this "supabase" (that breaks the library)
    const supabaseClient = window.supabase.createClient(
      "https://pepajrlrnaquyuaitlnb.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlcGFqcmxybmFxdXl1YWl0bG5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MzIxNTEsImV4cCI6MjA4NTMwODE1MX0.bd3yyV_yiRlu3PFcxc-CZjb_ooa5ze-x4TurOtOXQLg",
      {
        auth: {
          persistSession: true,
          detectSessionInUrl: true,
          autoRefreshToken: true
        }
      }
    );

    async function requireAuth() {
      // If user just clicked a magic link, Supabase can detect session in URL automatically,
      // but we still check session after load.
      const { data, error } = await supabaseClient.auth.getSession();
      if (error) console.warn("getSession error:", error);

      if (!data || !data.session) {
        window.location.href = "/login.html";
      }
    }

    // Run auth check ASAP
    requireAuth();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
    }
    .soft-shadow { box-shadow: 0 12px 40px rgba(0,0,0,0.35); }
    .divider { height: 1px; background: rgba(255,255,255,0.10); }

    /* Pro lock */
    .pro-wrap { position: relative; }
    .pro-locked {
      filter: blur(10px);
      opacity: 0.65;
      pointer-events: none;
      user-select: none;
    }
    .pro-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      border-radius: 16px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(34,197,94,0.20);
      backdrop-filter: blur(6px);
    }
    .pro-overlay-card {
      width: 100%;
      max-width: 560px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(17,24,39,0.70);
      padding: 18px;
      box-shadow: 0 12px 60px rgba(0,0,0,0.55);
    }

    /* Toggle */
    .toggle-pill {
      background: rgba(31,41,55,0.9);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 9999px;
      padding: 4px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
  </style>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen">

  <nav class="sticky top-0 z-50 border-b border-gray-800/70 bg-gray-950/80 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <a href="/index.html" class="flex items-center gap-2 hover:opacity-90 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 0 01-2-2z" />
        </svg>
        <span class="font-extrabold tracking-tight text-lg">TRUE<span class="text-green-500">ALPHA</span></span>
      </a>

      <div class="hidden md:flex items-center gap-6 text-sm text-gray-300">
        <a href="/methodology.html" class="hover:text-green-400 transition">Methodology</a>
        <a href="/faq.html" class="hover:text-green-400 transition">FAQ</a>
        <a href="/blog.html" class="hover:text-green-400 transition">Weekly Insights</a>
      </div>

      <div class="flex items-center gap-2">
        <a id="navUpgradeBtn"
           href="#pro"
           class="inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2.5 font-extrabold text-sm bg-green-600 hover:bg-green-500 transition shadow-lg shadow-green-600/20 border border-green-400/30">
          Upgrade to Pro <span aria-hidden="true">→</span>
        </a>

        <button id="alreadyProBtn"
           class="hidden sm:inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2.5 font-bold text-sm bg-gray-900 hover:bg-gray-800 transition border border-gray-700">
          Already Pro? Unlock <span aria-hidden="true">↗</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Everything below here is unchanged from your file -->
  <main id="content" class="max-w-7xl mx-auto px-4 py-10">

    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
      <div class="max-w-3xl">
        <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">Leaderboard</h1>
        <p class="mt-2 text-gray-400">
          A neutral scoreboard for creator predictions —
          <span class="text-green-400 font-semibold">alpha</span>,
          <span class="text-green-400 font-semibold">accuracy</span>,
          and how results change by time horizon.
        </p>

        <!-- PRO (Primary paid conversion) -->
        <section id="pro" class="mt-5 glass soft-shadow rounded-2xl p-5">
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div>
              <div class="text-[11px] text-gray-400 uppercase tracking-wider">Pro</div>
              <div class="text-base sm:text-lg font-extrabold mt-1">
                Unlock Pro: decision-grade breakdowns
              </div>
              <div class="text-xs text-gray-400 mt-1 leading-relaxed">
                Year-by-year alpha (2023–2025+), consistency (years beating S&amp;P), bull vs bear accuracy, and best/worst picks.
              </div>

              <ul class="mt-4 space-y-2 text-sm text-gray-200">
                <li class="flex gap-2"><span class="text-green-400">✓</span><span><b>Year-by-year alpha</b> + “Beat S&amp;P?” boolean per year</span></li>
                <li class="flex gap-2"><span class="text-green-400">✓</span><span><b>Consistency score</b> + streak view (“3/4 years beat S&amp;P”)</span></li>
                <li class="flex gap-2"><span class="text-green-400">✓</span><span><b>Bull vs Bear accuracy</b> (not just a lucky regime)</span></li>
                <li class="flex gap-2"><span class="text-green-400">✓</span><span><b>Signal filters</b>: Verified (N≥20), significance, 90/180/365</span></li>
                <li class="flex gap-2"><span class="text-green-400">✓</span><span><b>Best/Worst picks</b> + outlier-adjusted view</span></li>
              </ul>
            </div>

            <div class="md:text-right">
              <div class="text-[11px] text-gray-400 uppercase tracking-wider">Pricing</div>

              <div class="mt-2 inline-flex items-center justify-end">
                <div class="toggle-pill">
                  <button id="lbMonthlyBtn" class="px-4 py-2 text-sm font-extrabold rounded-full bg-green-600 text-white transition">
                    Monthly
                  </button>
                  <button id="lbAnnualBtn" class="px-4 py-2 text-sm font-extrabold rounded-full text-gray-300 hover:text-white transition relative">
                    Annual
                    <span class="absolute -top-2 -right-3 text-[10px] px-2 py-0.5 rounded-full bg-green-500 text-black font-extrabold">
                      SAVE 35%
                    </span>
                  </button>
                </div>
              </div>

              <div id="lbPriceText" class="mt-4 text-3xl font-extrabold text-white">
                $19<span class="text-sm font-medium text-gray-400">/mo</span>
              </div>
              <div id="lbSubText" class="text-xs text-gray-400 mt-1">
                Cancel anytime.
              </div>

              <a id="lbCheckoutBtn"
                 href="https://buy.stripe.com/test_aFa6oH1TL8TGe5RcCPcfK00"
                 target="_blank"
                 class="mt-4 inline-flex items-center justify-center gap-2 rounded-xl px-4 py-3 font-extrabold text-sm bg-green-600 hover:bg-green-500 transition shadow-lg shadow-green-600/20 border border-green-400/30 w-full md:w-auto">
                Unlock Pro <span aria-hidden="true">→</span>
              </a>

              <div class="mt-2 text-[11px] text-gray-500">
                Tip: After Stripe, you can redirect to <span class="text-gray-300">/leaderboard/?pro=1</span> to auto-unlock.
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="flex flex-wrap gap-2 justify-start lg:justify-end">
        <div class="glass rounded-xl px-3 py-2 text-xs text-gray-300">
          <span class="text-gray-400">Last Updated:</span> <span id="lastUpdated">—</span>
        </div>
        <div class="glass rounded-xl px-3 py-2 text-xs text-gray-300">
          <span class="text-gray-400">Filter:</span> <span id="filterText">—</span>
        </div>
        <div class="glass rounded-xl px-3 py-2 text-xs text-gray-300">
          <span class="text-gray-400">Entry:</span> <span id="entryRule">—</span>
        </div>
        <div class="glass rounded-xl px-3 py-2 text-xs text-gray-300">
          <span class="text-gray-400">Sig:</span> <span id="sigRule">—</span>
        </div>
      </div>
    </div>

    <!-- PRO-ONLY SECTION (Blurred) -->
    <section class="mt-8">
      <div class="pro-wrap glass soft-shadow rounded-2xl p-5">

        <div id="proContent" class="pro-locked">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-extrabold text-xl">Pro Panel: Consistency + Year-by-Year</h2>
              <p class="text-xs text-gray-400 mt-1">
                Year-by-year alpha (2023–2025+), “Beat S&amp;P?” flags, and consistency score.
              </p>
            </div>
            <div class="text-[11px] text-gray-400 uppercase tracking-wider">Pro only</div>
          </div>

          <div class="mt-5 grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-gray-400 uppercase tracking-wider">Consistency</div>
              <div class="mt-2 text-3xl font-extrabold text-white">3/4</div>
              <div class="text-xs text-gray-400 mt-1">Years beat S&amp;P (example)</div>
            </div>

            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-gray-400 uppercase tracking-wider">Bull vs Bear</div>
              <div class="mt-2 text-3xl font-extrabold text-white">+12%</div>
              <div class="text-xs text-gray-400 mt-1">Avg alpha in both regimes (example)</div>
            </div>

            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-gray-400 uppercase tracking-wider">Outlier-adjusted</div>
              <div class="mt-2 text-3xl font-extrabold text-white">Stable</div>
              <div class="text-xs text-gray-400 mt-1">Reduces 1 lucky 500% pick skew</div>
            </div>
          </div>

          <div class="mt-5 glass rounded-2xl p-4 overflow-x-auto">
            <div class="text-xs text-gray-400 uppercase tracking-wider mb-3">Year-by-year table (example layout)</div>
            <table class="min-w-[780px] w-full text-sm">
              <thead class="text-gray-400">
                <tr>
                  <th class="text-left py-2 pr-3">Creator</th>
                  <th class="text-left py-2 pr-3">Years Beat S&amp;P</th>
                  <th class="text-left py-2 pr-3">2023 Alpha</th>
                  <th class="text-left py-2 pr-3">2024 Alpha</th>
                  <th class="text-left py-2 pr-3">2025 Alpha</th>
                  <th class="text-left py-2 pr-3">Consistency</th>
                  <th class="text-left py-2 pr-3">Best / Worst</th>
                </tr>
              </thead>
              <tbody class="text-gray-200">
                <tr class="border-t border-gray-800/60">
                  <td class="py-3 pr-3 font-semibold">Tom Nash</td>
                  <td class="py-3 pr-3">3/4</td>
                  <td class="py-3 pr-3">+28.6%</td>
                  <td class="py-3 pr-3">+12.1%</td>
                  <td class="py-3 pr-3">—</td>
                  <td class="py-3 pr-3">High</td>
                  <td class="py-3 pr-3">+120% / -18%</td>
                </tr>
                <tr class="border-t border-gray-800/60">
                  <td class="py-3 pr-3 font-semibold">Stealth Wealth</td>
                  <td class="py-3 pr-3">2/3</td>
                  <td class="py-3 pr-3">—</td>
                  <td class="py-3 pr-3">+18.0%</td>
                  <td class="py-3 pr-3">—</td>
                  <td class="py-3 pr-3">Med</td>
                  <td class="py-3 pr-3">+55% / -9%</td>
                </tr>
              </tbody>
            </table>
            <div class="mt-3 text-[11px] text-gray-500">
              This section will be populated from your year columns as you farm more historical data.
            </div>
          </div>
        </div>

        <!-- Overlay -->
        <div id="proOverlay" class="pro-overlay">
          <div class="pro-overlay-card">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-[11px] text-gray-400 uppercase tracking-wider">Locked</div>
                <div class="text-lg font-extrabold mt-1">Pro-only panels (Consistency + Year-by-year)</div>
                <div class="text-xs text-gray-400 mt-1">
                  This is where people decide who’s “actually good” vs “one lucky year”.
                </div>
              </div>
              <div class="text-[11px] text-gray-400 uppercase tracking-wider">Pro</div>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row gap-3">
              <a id="proMonthlyLink"
                 href="https://buy.stripe.com/test_aFa6oH1TL8TGe5RcCPcfK00"
                 target="_blank"
                 class="w-full inline-flex items-center justify-center gap-2 rounded-xl px-4 py-3 font-extrabold text-sm bg-green-600 hover:bg-green-500 transition">
                Unlock Monthly ($19) →
              </a>

              <a id="proAnnualLink"
                 href="https://buy.stripe.com/test_8x24gz1TL2vi7Ht0U7cfK01"
                 target="_blank"
                 class="w-full inline-flex items-center justify-center gap-2 rounded-xl px-4 py-3 font-extrabold text-sm bg-gray-900 hover:bg-gray-800 transition border border-gray-700">
                Unlock Annual (Save 35%) →
              </a>
            </div>

            <div class="mt-3 flex items-center justify-between gap-3">
              <button id="unlockLocalBtn"
                class="text-xs font-extrabold text-gray-200 hover:text-white underline">
                I already purchased — unlock
              </button>

              <div class="text-[11px] text-gray-500">
                (Temporary) Uses localStorage until member auth exists.
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- FREE SECTIONS -->
    <section class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">

      <div class="glass soft-shadow rounded-2xl p-5">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="font-bold text-lg">Top + Bottom by Alpha</h2>
            <p class="text-xs text-gray-400 mt-1" id="alphaSub">—</p>
          </div>
          <div class="text-[11px] text-gray-400 uppercase tracking-wider">Avg Alpha</div>
        </div>

        <div class="mt-5">
          <div class="text-xs font-bold text-green-400 tracking-wider">TOP</div>
          <div id="alphaTop" class="mt-3 space-y-2"></div>
        </div>

        <div class="mt-6">
          <div class="text-xs font-bold text-red-400 tracking-wider">BOTTOM</div>
          <div id="alphaBottom" class="mt-3 space-y-2"></div>
        </div>
      </div>

      <div class="glass soft-shadow rounded-2xl p-5">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="font-bold text-lg">Top + Bottom by Accuracy</h2>
            <p class="text-xs text-gray-400 mt-1" id="accuracySub">—</p>
          </div>
          <div class="text-[11px] text-gray-400 uppercase tracking-wider">Accuracy</div>
        </div>

        <div class="mt-5">
          <div class="text-xs font-bold text-green-400 tracking-wider">TOP</div>
          <div id="accTop" class="mt-3 space-y-2"></div>
        </div>

        <div class="mt-6">
          <div class="text-xs font-bold text-red-400 tracking-wider">BOTTOM</div>
          <div id="accBottom" class="mt-3 space-y-2"></div>
        </div>
      </div>

      <div class="glass soft-shadow rounded-2xl p-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="font-bold text-lg">Commonly Mentioned Assets</h2>
            <p class="text-xs text-gray-400 mt-1" id="stocksSub">—</p>
          </div>
          <div class="text-[11px] text-gray-400 uppercase tracking-wider">Mentions</div>
        </div>

        <div id="stocksList" class="mt-4 space-y-2"></div>

        <a id="dbBtnCard"
           href="#"
           target="_blank"
           class="mt-6 w-full inline-flex items-center justify-center gap-2 rounded-xl px-4 py-3 font-extrabold text-sm bg-gray-900 hover:bg-gray-800 transition border border-gray-700">
          Open dataset <span aria-hidden="true">↗</span>
        </a>

        <div class="mt-3 text-[11px] text-gray-500">Powered by the public dataset.</div>
      </div>

    </section>

    <section class="mt-6 glass soft-shadow rounded-2xl p-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="font-bold text-lg">Alpha by Time Horizon</h2>
          <p class="text-xs text-gray-400 mt-1">90D vs 180D vs 365D</p>
        </div>
        <div class="text-[11px] text-gray-400 uppercase tracking-wider">90 / 180 / 365</div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold" id="d90Label">90D</div>
            <div class="text-xs text-gray-400">alpha</div>
          </div>
          <div class="mt-4">
            <div class="text-xs font-bold text-green-400 tracking-wider">TOP</div>
            <div id="d90Top" class="mt-3 space-y-2"></div>
          </div>
          <div class="mt-4">
            <div class="text-xs font-bold text-red-400 tracking-wider">BOTTOM</div>
            <div id="d90Bottom" class="mt-3 space-y-2"></div>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold" id="d180Label">180D</div>
            <div class="text-xs text-gray-400">alpha</div>
          </div>
          <div class="mt-4">
            <div class="text-xs font-bold text-green-400 tracking-wider">TOP</div>
            <div id="d180Top" class="mt-3 space-y-2"></div>
          </div>
          <div class="mt-4">
            <div class="text-xs font-bold text-red-400 tracking-wider">BOTTOM</div>
            <div id="d180Bottom" class="mt-3 space-y-2"></div>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold" id="d365Label">365D</div>
            <div class="text-xs text-gray-400">alpha</div>
          </div>
          <div class="mt-4">
            <div class="text-xs font-bold text-green-400 tracking-wider">TOP</div>
            <div id="d365Top" class="mt-3 space-y-2"></div>
          </div>
          <div class="mt-4">
            <div class="text-xs font-bold text-red-400 tracking-wider">BOTTOM</div>
            <div id="d365Bottom" class="mt-3 space-y-2"></div>
          </div>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-between text-[11px] text-gray-500">
        <span>Alpha = Stock return − S&amp;P 500 return (same horizon). Sig uses p-value.</span>
        <a id="dbLinkBottom"
           href="#"
           target="_blank"
           class="text-green-400 hover:text-green-300 font-semibold">
          Open dataset →
        </a>
      </div>
    </section>

  </main>

  <footer class="border-t border-gray-800/70 bg-gray-950 py-10 mt-10">
    <div class="max-w-7xl mx-auto px-4 text-sm text-gray-500 flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
      <div>
        <div class="font-semibold text-gray-300">True Alpha Research</div>
        <div class="text-xs mt-1">Not financial advice. For entertainment & data purposes only.</div>
      </div>
      <div class="text-xs flex items-center gap-4">
        <a href="https://x.com/TruealphaInvest" target="_blank" class="hover:text-green-400">X / Twitter</a>
      </div>
    </div>
  </footer>

  <script>
    // ===== Stripe links =====
    const STRIPE_MONTHLY = "https://buy.stripe.com/test_aFa6oH1TL8TGe5RcCPcfK00";
    const STRIPE_ANNUAL  = "https://buy.stripe.com/test_00w9AT41Tfi41j5eKXcfK02";

    // ===== Pro unlock (temporary localStorage gate) =====
    const PRO_KEY = "ta_pro";
    const proContent = document.getElementById("proContent");
    const proOverlay = document.getElementById("proOverlay");
    const unlockLocalBtn = document.getElementById("unlockLocalBtn");
    const alreadyProBtn = document.getElementById("alreadyProBtn");

    function isPro() {
      return localStorage.getItem(PRO_KEY) === "1";
    }

    function setPro(v) {
      localStorage.setItem(PRO_KEY, v ? "1" : "0");
      renderPro();
    }

    function renderPro() {
      const unlocked = isPro();
      if (unlocked) {
        proContent.classList.remove("pro-locked");
        proOverlay.style.display = "none";
        alreadyProBtn.textContent = "Pro Unlocked ✓";
      } else {
        proContent.classList.add("pro-locked");
        proOverlay.style.display = "flex";
        alreadyProBtn.textContent = "Already Pro? Unlock ↗";
      }
      alreadyProBtn.classList.remove("hidden");
    }

    (function autoUnlockFromQuery() {
      const params = new URLSearchParams(window.location.search);
      if (params.get("pro") === "1") {
        setPro(true);
        params.delete("pro");
        const newUrl = `${window.location.pathname}${params.toString() ? `?${params.toString()}` : ""}`;
        window.history.replaceState({}, "", newUrl);
      }
    })();

    unlockLocalBtn.addEventListener("click", () => setPro(true));
    alreadyProBtn.addEventListener("click", () => setPro(true));

    const lbMonthlyBtn  = document.getElementById("lbMonthlyBtn");
    const lbAnnualBtn   = document.getElementById("lbAnnualBtn");
    const lbPriceText   = document.getElementById("lbPriceText");
    const lbSubText     = document.getElementById("lbSubText");
    const lbCheckoutBtn = document.getElementById("lbCheckoutBtn");

    function setLBMonthly() {
      lbMonthlyBtn.classList.add("bg-green-600","text-white");
      lbMonthlyBtn.classList.remove("text-gray-300");
      lbAnnualBtn.classList.remove("bg-green-600","text-white");
      lbAnnualBtn.classList.add("text-gray-300");

      lbPriceText.innerHTML = `$19<span class="text-sm font-medium text-gray-400">/mo</span>`;
      lbSubText.textContent = "Cancel anytime.";
      lbCheckoutBtn.href = STRIPE_MONTHLY;
    }

    function setLBAnnual() {
      lbAnnualBtn.classList.add("bg-green-600","text-white");
      lbAnnualBtn.classList.remove("text-gray-300");
      lbMonthlyBtn.classList.remove("bg-green-600","text-white");
      lbMonthlyBtn.classList.add("text-gray-300");

      lbPriceText.innerHTML = `$149<span class="text-sm font-medium text-gray-400">/yr</span>`;
      lbSubText.textContent = "Save 35%. Equivalent to $12.42/mo.";
      lbCheckoutBtn.href = STRIPE_ANNUAL;
    }

    lbMonthlyBtn.addEventListener("click", setLBMonthly);
    lbAnnualBtn.addEventListener("click", setLBAnnual);

    document.getElementById("proMonthlyLink").href = STRIPE_MONTHLY;
    document.getElementById("proAnnualLink").href  = STRIPE_ANNUAL;

    renderPro();
  </script>

  <script>
    const JSON_PATH = "./leaderboard.json";

    function toNumber(x) {
      if (x === null || x === undefined) return NaN;
      if (typeof x === "number") return x;
      if (typeof x !== "string") return Number(x);

      const s = x.trim();
      if (!s) return NaN;

      if (s.endsWith("%")) {
        const n = Number(s.replace("%", "").trim());
        return Number.isFinite(n) ? n : NaN;
      }

      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    const fmtPct = (n, decimals = 2) => {
      const num = toNumber(n);
      if (!Number.isFinite(num)) return "—";
      const sign = num > 0 ? "+" : "";
      return `${sign}${num.toFixed(decimals)}%`;
    };

    const fmtRate = (n) => {
      const num = toNumber(n);
      if (!Number.isFinite(num)) return "—";
      return `${num.toFixed(2)}%`;
    };

    function fmtP(pValue) {
      const p = toNumber(pValue);
      if (!Number.isFinite(p)) return "";
      return `p=${p.toFixed(4)}`;
    }

    function pillRank(rank, kind) {
      const base = "w-7 h-7 rounded-full flex items-center justify-center text-xs font-extrabold";
      if (kind === "good") return `<div class="${base} bg-green-500/15 text-green-300 border border-green-400/20">${rank}</div>`;
      if (kind === "bad") return `<div class="${base} bg-red-500/15 text-red-300 border border-red-400/20">${rank}</div>`;
      return `<div class="${base} bg-gray-500/15 text-gray-200 border border-gray-400/20">${rank}</div>`;
    }

    function sigPill(sig) {
      if (!sig) return "";
      return `<span class="ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-extrabold bg-green-500/15 text-green-300 border border-green-400/20">Sig</span>`;
    }

    function rowCreator({ rank, creator, valueText, valueClass, subText }) {
      return `
        <div class="flex items-center justify-between gap-3 px-3 py-2 rounded-xl bg-white/0 hover:bg-white/5 transition">
          <div class="flex items-center gap-3 min-w-0">
            ${rank}
            <div class="min-w-0">
              <div class="text-sm font-semibold text-gray-100 truncate">${creator}</div>
              <div class="text-[11px] text-gray-400">${subText}</div>
            </div>
          </div>
          <div class="text-sm font-extrabold ${valueClass} whitespace-nowrap">${valueText}</div>
        </div>
      `;
    }

    function rowTicker({ ticker, mentions }) {
      return `
        <div class="flex items-center justify-between gap-3 px-3 py-2 rounded-xl bg-white/0 hover:bg-white/5 transition">
          <div class="text-sm font-extrabold tracking-wide">${ticker}</div>
          <div class="text-xs text-gray-400">${mentions} mentions</div>
        </div>
      `;
    }

    function setDbLinks(url) {
      ["dbBtnCard", "dbLinkBottom"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.href = url || "#";
      });
    }

    async function initLeaderboard() {
      try {
        const res = await fetch(JSON_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        document.getElementById("lastUpdated").textContent = data?.meta?.lastUpdated || "—";
        document.getElementById("filterText").textContent = data?.meta?.filter || "—";
        document.getElementById("entryRule").textContent = data?.meta?.entry || "—";
        document.getElementById("sigRule").textContent = data?.meta?.significanceRule || "—";

        document.getElementById("alphaSub").textContent = data?.meta?.metricAlpha || "—";
        document.getElementById("accuracySub").textContent = data?.meta?.metricAccuracy || "—";
        document.getElementById("stocksSub").textContent = data?.stocksRecommended?.note || "—";

        setDbLinks(data?.meta?.databaseUrl || "#");

        const alphaTop = (data?.alpha?.top || []).slice(0, 4).map((x) => rowCreator({
          rank: pillRank(x.rank ?? "", "good"),
          creator: x.creator || "—",
          valueText: fmtPct(x.avgAlpha),
          valueClass: "text-green-300",
          subText: `${typeof x.n === "number" ? `n=${x.n}` : ""} ${fmtP(x.pValue)} ${sigPill(!!x.sig)}`.trim()
        })).join("");

        const alphaBottom = (data?.alpha?.bottom || []).slice(0, 4).map((x) => rowCreator({
          rank: pillRank(x.rank ?? "", "bad"),
          creator: x.creator || "—",
          valueText: fmtPct(x.avgAlpha),
          valueClass: "text-red-300",
          subText: `${typeof x.n === "number" ? `n=${x.n}` : ""} ${fmtP(x.pValue)} ${sigPill(!!x.sig)}`.trim()
        })).join("");

        document.getElementById("alphaTop").innerHTML = alphaTop || `<div class="text-sm text-gray-400">No data.</div>`;
        document.getElementById("alphaBottom").innerHTML = alphaBottom || `<div class="text-sm text-gray-400">No data.</div>`;

        const accTop = (data?.accuracy?.top || []).slice(0, 4).map((x) => rowCreator({
          rank: pillRank(x.rank ?? "", "good"),
          creator: x.creator || "—",
          valueText: fmtRate(x.winRate),
          valueClass: "text-green-300",
          subText: `${typeof x.n === "number" ? `n=${x.n}` : ""} ${fmtP(x.pValue)} ${sigPill(!!x.sig)}`.trim()
        })).join("");

        const accBottom = (data?.accuracy?.bottom || []).slice(0, 4).map((x) => rowCreator({
          rank: pillRank(x.rank ?? "", "bad"),
          creator: x.creator || "—",
          valueText: fmtRate(x.winRate),
          valueClass: "text-red-300",
          subText: `${typeof x.n === "number" ? `n=${x.n}` : ""} ${fmtP(x.pValue)} ${sigPill(!!x.sig)}`.trim()
        })).join("");

        document.getElementById("accTop").innerHTML = accTop || `<div class="text-sm text-gray-400">No data.</div>`;
        document.getElementById("accBottom").innerHTML = accBottom || `<div class="text-sm text-gray-400">No data.</div>`;

        const stocks = (data?.stocksRecommended?.items || []).slice(0, 8).map(rowTicker).join("");
        document.getElementById("stocksList").innerHTML = stocks || `<div class="text-sm text-gray-400">No data.</div>`;

        const d90 = data?.intervals?.d90 || {};
        const d180 = data?.intervals?.d180 || {};
        const d365 = data?.intervals?.d365 || {};

        document.getElementById("d90Label").textContent = d90.label || "90D";
        document.getElementById("d180Label").textContent = d180.label || "180D";
        document.getElementById("d365Label").textContent = d365.label || "365D";

        const renderTopBottom = (block, topId, bottomId) => {
          const top = (block.top || []).slice(0, 3).map(x => rowCreator({
            rank: pillRank(x.rank ?? "", "good"),
            creator: x.creator || "—",
            valueText: fmtPct(x.alpha),
            valueClass: "text-green-300",
            subText: `${fmtP(x.pValue)} ${sigPill(!!x.sig)}`.trim()
          })).join("");

          const bottom = (block.bottom || []).slice(0, 3).map(x => rowCreator({
            rank: pillRank(x.rank ?? "", "bad"),
            creator: x.creator || "—",
            valueText: fmtPct(x.alpha),
            valueClass: "text-red-300",
            subText: `${fmtP(x.pValue)} ${sigPill(!!x.sig)}`.trim()
          })).join("");

          document.getElementById(topId).innerHTML = top || `<div class="text-sm text-gray-400">No data.</div>`;
          document.getElementById(bottomId).innerHTML = bottom || `<div class="text-sm text-gray-400">No data.</div>`;
        };

        renderTopBottom(d90, "d90Top", "d90Bottom");
        renderTopBottom(d180, "d180Top", "d180Bottom");
        renderTopBottom(d365, "d365Top", "d365Bottom");

      } catch (e) {
        console.error(e);
        const ids = ["alphaTop","alphaBottom","accTop","accBottom","stocksList","d90Top","d90Bottom","d180Top","d180Bottom","d365Top","d365Bottom"];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = `<div class="text-sm text-red-300">Failed to load leaderboard.json</div>`;
        });
      }
    }

    initLeaderboard();
  </script>

</body>
</html>
